{% extends "base.html" %}
{% block title %}–§–∏–Ω–∞–Ω—Å—ã ‚Äî {{ wedding.name }}{% endblock %}

{% block content %}
<a href="{{ url_for('wedding_pages.view_wedding', wedding_id=wedding.id) }}"
   class="inline-flex items-center gap-2 text-indigo-700 hover:text-indigo-900 mb-6">
  <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
  </svg>
  –ö –æ–±–∑–æ—Ä—É —Å–≤–∞–¥—å–±—ã
</a>

<h2 class="text-2xl font-extrabold tracking-tight mb-4">
  –§–∏–Ω–∞–Ω—Å—ã ‚Äî <span class="text-pink-700">{{ wedding.name }}</span>
</h2>

{# ====== –ê–ì–†–ï–ì–ê–¢–´ ====== #}
{% set plan_sum   = wedding.expenses | sum(attribute='plan')        or 0 %}
{% set fact_sum   = wedding.expenses | sum(attribute='fact')        or 0 %}
{% set prepay_sum = wedding.expenses | sum(attribute='prepayment')  or 0 %}
{% set total_sum  = wedding.expenses | sum(attribute='total')       or 0 %}
{# —á–µ–º —Å—á–∏—Ç–∞—Ç—å ¬´–ø–æ—Ç—Ä–∞—á–µ–Ω–æ¬ª: –µ—Å–ª–∏ –µ—Å—Ç—å —Ñ–∞–∫—Ç ‚Äî –±–µ—Ä—ë–º –µ–≥–æ, –∏–Ω–∞—á–µ sum(total) #}
{% set spent = fact_sum if fact_sum else total_sum %}
{% set diff  = fact_sum - plan_sum %}
{% set budget = wedding.budget or 0 %}

{# —Å—É–º–º–∞ –ø–æ–¥–∞—Ä–∫–æ–≤/—Å–ø–æ–Ω—Å–æ—Ä–æ–≤ #}
{% set sponsors_total = sponsors | sum(attribute='amount') or 0 %}

{# –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π –±—é–¥–∂–µ—Ç = –ø–ª–∞–Ω–æ–≤—ã–π –±—é–¥–∂–µ—Ç + –ø–æ–¥–∞—Ä–∫–∏ #}
{% set effective_budget = budget + sponsors_total %}
{% set progress = (spent * 100 / (effective_budget if effective_budget > 0 else 1)) if effective_budget > 0 else 0 %}
{% set remain_vs_budget = budget - spent %}
{% set remain_vs_effective = effective_budget - spent %}

<div class="grid xl:grid-cols-4 md:grid-cols-2 gap-4 mb-6">
  <div class="bg-white rounded-2xl border p-4 shadow">
    <div class="text-gray-500 text-sm mb-1">–î–æ—Å—Ç—É–ø–Ω–æ –≤—Å–µ–≥–æ (–±—é–¥–∂–µ—Ç + –ø–æ–¥–∞—Ä–∫–∏)</div>
    <div class="text-2xl font-black">{{ effective_budget|int }} —Å—É–º</div>
    <div class="mt-3">
      <div class="w-full h-2 rounded-full bg-pink-100 overflow-hidden">
        <div class="h-2 bg-pink-600" style="width: {{ progress|round(1) }}%"></div>
      </div>
      <div class="mt-1 text-xs text-gray-600">
        –ò–∑—Ä–∞—Å—Ö–æ–¥–æ–≤–∞–Ω–æ: <b>{{ spent|int }}</b> ({{ progress|round(1) }}%)
      </div>
    </div>
  </div>

  <div class="bg-white rounded-2xl border p-4 shadow">
    <div class="text-gray-500 text-sm mb-1">–ë—é–¥–∂–µ—Ç (–ø–ª–∞–Ω)</div>
    <div class="text-2xl font-black text-amber-700">{{ budget|int }} —Å—É–º</div>
  </div>

  <div class="bg-white rounded-2xl border p-4 shadow">
    <div class="text-gray-500 text-sm mb-1">–ü–æ–¥–∞—Ä–∫–∏/—Å–ø–æ–Ω—Å–æ—Ä—ã</div>
    <div class="text-2xl font-black text-emerald-700">+{{ sponsors_total|int }} —Å—É–º</div>
  </div>

  <div class="bg-white rounded-2xl border p-4 shadow">
    <div class="text-gray-500 text-sm mb-1">–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞</div>
    <div class="text-2xl font-black text-sky-700">{{ prepay_sum|int }} —Å—É–º</div>
  </div>
</div>

<div class="grid lg:grid-cols-3 gap-6 mb-8">
  <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤/–¥–µ–ª—å—Ç—ã -->
  <div class="bg-white rounded-2xl shadow border p-5 lg:col-span-1">
    <form method="POST" action="{{ url_for('finance_bp.update_budget', wedding_id=wedding.id) }}" class="space-y-3">
      <label class="block text-sm font-semibold text-gray-700">–ë—é–¥–∂–µ—Ç —Å–≤–∞–¥—å–±—ã (—Å—É–º)</label>
      <input type="number" step="0.01" min="0" name="budget" value="{{ wedding.budget or '' }}"
             class="border px-3 py-2 rounded-xl w-full focus:ring-2 focus:ring-pink-200" placeholder="–í–≤–µ–¥–∏—Ç–µ –±—é–¥–∂–µ—Ç">
      <button type="submit"
              class="bg-pink-600 hover:bg-pink-700 text-white rounded-xl px-4 py-2 shadow">
        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –±—é–¥–∂–µ—Ç
      </button>
    </form>

    <div class="mt-5 grid grid-cols-2 gap-3 text-sm">
      <div class="bg-emerald-50 border border-emerald-100 rounded-xl p-3">
        <div class="text-gray-500">–ò–∑—Ä–∞—Å—Ö–æ–¥–æ–≤–∞–Ω–æ</div>
        <div class="font-bold text-emerald-700">{{ spent|int }} —Å—É–º</div>
      </div>
      <div class="bg-indigo-50 border border-indigo-100 rounded-xl p-3">
        <div class="text-gray-500">–û—Å—Ç–∞—Ç–æ–∫ (–æ—Ç ¬´–¥–æ—Å—Ç—É–ø–Ω–æ –≤—Å–µ–≥–æ¬ª)</div>
        <div class="font-bold text-indigo-700">{{ remain_vs_effective|int }} —Å—É–º</div>
      </div>
      <div class="bg-rose-50 border border-rose-100 rounded-xl p-3 col-span-2">
        <div class="text-gray-500">–†–∞–∑–Ω–∏—Ü–∞ –§–∞–∫—Ç ‚àí –ü–ª–∞–Ω</div>
        <div class="font-bold {{ diff >= 0 and 'text-rose-700' or 'text-emerald-700' }}">
          {{ diff|int }} —Å—É–º
        </div>
      </div>
    </div>
  </div>

  <!-- –î–∏–∞–≥—Ä–∞–º–º–∞ -->
  <div class="bg-white rounded-2xl shadow border p-5 lg:col-span-2 flex flex-col">
    <div class="font-bold mb-2">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</div>
    <div class="flex-1 flex items-center justify-center min-h-[220px]">
      <canvas id="expenseChart" width="360" height="220"></canvas>
    </div>
    {% if not expense_categories %}
      <div class="text-gray-400 text-sm mt-2">–ù–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞</div>
    {% endif %}
    <div class="mt-4 flex flex-wrap gap-2">
      {% for label in expense_categories %}
        <span class="px-2 py-1 rounded-lg border bg-gray-50 text-gray-600 text-xs">{{ label }}</span>
      {% endfor %}
    </div>
  </div>
</div>

<!-- –°–ü–û–ù–°–û–†–´ -->
<div class="bg-white rounded-2xl shadow border p-5">
  <div class="font-bold mb-3">–°–ø–æ–Ω—Å–æ—Ä—ã –∏ –ø–æ–¥–∞—Ä–∫–∏</div>

  <form method="POST" action="{{ url_for('finance_bp.add_sponsor', wedding_id=wedding.id) }}"
        class="mb-4 grid md:grid-cols-4 gap-2">
    <select name="guest_id" required class="border px-3 py-2 rounded-xl">
      <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Å—Ç—è</option>
      {% for guest in guests %}
        {% set label =
             (guest.family_name ~ (' ' ~ guest.name if guest.name else ''))
             if guest.family_name
             else (guest.name if guest.name else ('–ì–æ—Å—Ç—å #' ~ guest.id)) %}
        <option value="{{ guest.id }}">{{ label }}</option>
      {% endfor %}
    </select>
    <input name="amount" type="number" step="0.01" placeholder="–°—É–º–º–∞" required class="border px-3 py-2 rounded-xl">
    <input name="notes" placeholder="–ü–æ–¥–∞—Ä–æ–∫/–ø—Ä–∏–º–µ—á–∞–Ω–∏–µ" class="border px-3 py-2 rounded-xl md:col-span-2">
    <div class="md:col-span-4">
      <button type="submit" class="bg-pink-600 hover:bg-pink-700 text-white rounded-xl px-4 py-2 shadow">
        –î–æ–±–∞–≤–∏—Ç—å
      </button>
    </div>
  </form>

  <div class="overflow-x-auto rounded-xl border">
    <table class="min-w-full text-sm">
      <thead class="bg-pink-50">
        <tr>
          <th class="p-2 text-left font-semibold">–ì–æ—Å—Ç—å</th>
          <th class="p-2 text-right font-semibold">–°—É–º–º–∞</th>
          <th class="p-2 text-left font-semibold">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th>
          <th class="p-2 text-center font-semibold">–î–µ–π—Å—Ç–≤–∏–µ</th>
        </tr>
      </thead>
      <tbody>
        {% for s in sponsors %}
        {% set glabel = (
            (s.guest.family_name ~ (' ' ~ s.guest.name if s.guest.name else ''))
            if s.guest and s.guest.family_name
            else (s.guest.name if s.guest and s.guest.name else ('–ì–æ—Å—Ç—å #' ~ (s.guest.id if s.guest else s.id)))
        ) %}
        <tr class="bg-white hover:bg-pink-50/60 transition">
          <td class="p-2">{{ glabel }}</td>
          <td class="p-2 text-right text-pink-700 font-semibold">+{{ s.amount|int }}</td>
          <td class="p-2 text-gray-600">{{ s.notes }}</td>
          <td class="p-2 text-center">
            <form method="POST" action="{{ url_for('finance_bp.delete_sponsor', wedding_id=wedding.id, sponsor_id=s.id) }}" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?');">
              <button class="px-2 py-1 rounded-lg bg-rose-50 hover:bg-rose-100 text-rose-700 border border-rose-100">üóëÔ∏è</button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr><td colspan="4" class="p-3 text-center text-gray-400">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr class="bg-pink-50">
          <th class="p-2 text-right">–ò—Ç–æ–≥–æ:</th>
          <th class="p-2 text-right text-pink-700 font-bold">+{{ sponsors_total|int }}</th>
          <th class="p-2" colspan="2"></th>
        </tr>
      </tfoot>
    </table>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const ctx = document.getElementById('expenseChart').getContext('2d');
const labels = {{ expense_categories|tojson }};
const values = {{ expense_amounts|tojson }};
if (labels.length && values.length) {
  new Chart(ctx, {
    type: 'pie',
    data: {
      labels,
      datasets: [{
        data: values,
        backgroundColor: ['#f472b6','#818cf8','#34d399','#fdba74','#facc15','#60a5fa','#a78bfa','#c084fc']
      }]
    },
    options: { plugins: { legend: { position: 'bottom' } } }
  });
}
</script>
{% endblock %}
